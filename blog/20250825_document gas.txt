// =========================================================================
// WHITE HOTEL Kamakura ãƒ–ãƒ­ã‚°è‡ªå‹•æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ ï¼ˆGitHubç‰ˆï¼‰- Google Apps Script
// =========================================================================

// === GitHubè¨­å®š ===
const GITHUB_CONFIG = {
  owner: 'sena-sakuramoto',                    // GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼å
  repo: 'white-hotel-site',                  // ãƒªãƒã‚¸ãƒˆãƒªå
  token: PropertiesService.getScriptProperties().getProperty('GITHUB_TOKEN'), // GitHubãƒˆãƒ¼ã‚¯ãƒ³
  branch: 'master'                             // ãƒ–ãƒ©ãƒ³ãƒåï¼ˆmainã¾ãŸã¯masterï¼‰
};

/**
 * ãƒ¡ã‚¤ãƒ³é–¢æ•°ï¼šGoogleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒ–ãƒ­ã‚°è¨˜äº‹ã¨ã—ã¦å…¬é–‹ï¼ˆç”»åƒå¯¾å¿œä¿®æ­£ç‰ˆï¼‰
 */
function publishBlogToGitHub(documentId) {
  try {
    console.log('ãƒ–ãƒ­ã‚°å…¬é–‹é–‹å§‹ï¼ˆç”»åƒå¯¾å¿œä¿®æ­£ç‰ˆï¼‰');
    
    var doc = DocumentApp.openById(documentId);
    var title = doc.getName();
    
    // ã¾ãšç”»åƒã‚’æ¤œå‡º
    console.log('ç”»åƒæ¤œå‡ºã‚’é–‹å§‹...');
    var images = extractAllImages(doc);
    console.log('æ¤œå‡ºã•ã‚ŒãŸç”»åƒæ•°: ' + images.length);
    
    // HTMLã«å¤‰æ›
    var htmlData = convertDocToHTMLWithImages(doc, images);
    console.log('HTMLå¤‰æ›å®Œäº†ã€‚ç›®æ¬¡é …ç›®æ•°: ' + htmlData.toc.length);
    
    var fileName = createSlug(title) + '.html';
    
    // ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    var uploadedImages = 0;
    var imageUrlMap = {};
    
    for (var i = 0; i < images.length; i++) {
      try {
        console.log('ç”»åƒ ' + (i + 1) + ' ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
        var imageResult = uploadImageToGitHub(images[i]);
        if (imageResult.success) {
          uploadedImages++;
          imageUrlMap[images[i].placeholder] = imageResult.url;
          console.log('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: ' + images[i].filename);
        } else {
          console.error('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + imageResult.error);
        }
      } catch (imageError) {
        console.error('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', imageError);
      }
    }
    
    console.log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ç”»åƒæ•°: ' + uploadedImages);
    
    // HTMLã®ç”»åƒãƒ‘ã‚¹ã‚’ç½®æ›
    var fullHTML = createEnhancedBlogHTML(htmlData.content, title, htmlData.toc);
    for (var placeholder in imageUrlMap) {
      fullHTML = fullHTML.replace(new RegExp(placeholder, 'g'), imageUrlMap[placeholder]);
    }
    
    // è¨˜äº‹ã‚’GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    createOrUpdateFile('blog/' + fileName, fullHTML, 'Add blog post: ' + title);
    
    // ãƒ–ãƒ­ã‚°ä¸€è¦§ã‚’æ›´æ–°
    updateBlogIndexOnGitHub(title, fileName);
    
    console.log('ãƒ–ãƒ­ã‚°å…¬é–‹å®Œäº†ï¼ˆç”»åƒ: ' + uploadedImages + 'æšï¼‰');
    return { 
      success: true, 
      message: 'ãƒ–ãƒ­ã‚°è¨˜äº‹ã€Œ' + title + 'ã€ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸã€‚ç”»åƒ' + uploadedImages + 'æšã‚’å«ã¿ã¾ã™ã€‚5-10åˆ†å¾Œã«ã‚µã‚¤ãƒˆã«åæ˜ ã•ã‚Œã¾ã™ã€‚', 
      fileName: fileName,
      url: 'https://white-hotel.archi-prisma.co.jp/blog/' + fileName,
      imagesCount: uploadedImages
    };
    
  } catch (error) {
    console.error('ã‚¨ãƒ©ãƒ¼:', error);
    return { success: false, message: 'ã‚¨ãƒ©ãƒ¼: ' + error.toString() };
  }
}

/**
 * ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰å…¨ã¦ã®ç”»åƒã‚’æŠ½å‡º
 */
function extractAllImages(doc) {
  var images = [];
  var body = doc.getBody();
  
  // ãƒœãƒ‡ã‚£å†…ã®å…¨ã¦ã®è¦ç´ ã‚’å†å¸°çš„ã«æ¤œç´¢
  function searchForImages(element) {
    var type = element.getType();
    
    if (type === DocumentApp.ElementType.INLINE_IMAGE) {
      var inlineImage = element.asInlineImage();
      var blob = inlineImage.getBlob();
      var imageData = {
        blob: blob,
        filename: 'image_' + Date.now() + '_' + images.length + '.png',
        placeholder: '{{IMAGE_PLACEHOLDER_' + images.length + '}}'
      };
      images.push(imageData);
      console.log('ç”»åƒã‚’ç™ºè¦‹: ' + imageData.filename);
      return imageData.placeholder;
    }
    
    // å­è¦ç´ ãŒã‚ã‚‹å ´åˆã¯å†å¸°çš„ã«æ¤œç´¢
    if (type === DocumentApp.ElementType.PARAGRAPH) {
      var paragraph = element.asParagraph();
      var numChildren = paragraph.getNumChildren();
      for (var i = 0; i < numChildren; i++) {
        var child = paragraph.getChild(i);
        searchForImages(child);
      }
    } else if (type === DocumentApp.ElementType.TABLE) {
      var table = element.asTable();
      var numRows = table.getNumRows();
      for (var i = 0; i < numRows; i++) {
        var row = table.getRow(i);
        var numCells = row.getNumCells();
        for (var j = 0; j < numCells; j++) {
          var cell = row.getCell(j);
          var numCellChildren = cell.getNumChildren();
          for (var k = 0; k < numCellChildren; k++) {
            searchForImages(cell.getChild(k));
          }
        }
      }
    } else if (type === DocumentApp.ElementType.LIST_ITEM) {
      var listItem = element.asListItem();
      var numChildren = listItem.getNumChildren();
      for (var i = 0; i < numChildren; i++) {
        searchForImages(listItem.getChild(i));
      }
    }
  }
  
  // ãƒœãƒ‡ã‚£ã®å…¨å­è¦ç´ ã‚’æ¤œç´¢
  var numChildren = body.getNumChildren();
  for (var i = 0; i < numChildren; i++) {
    searchForImages(body.getChild(i));
  }
  
  console.log('ç”»åƒæ¤œç´¢å®Œäº†ã€‚åˆè¨ˆ: ' + images.length + 'æš');
  return images;
}

/**
 * Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’HTMLã«å¤‰æ›ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°ï¼ˆæ›¸å¼å¯¾å¿œç‰ˆï¼‰
 */
function convertDocToHTMLWithImages(doc, images) {
  var body = doc.getBody();
  var numChildren = body.getNumChildren();
  var html = '';
  var toc = [];
  var inList = false;
  var imageIndex = 0;

  for (var i = 0; i < numChildren; i++) {
    var element = body.getChild(i);
    var type = element.getType();

    // ç¾åœ¨ã®è¦ç´ ãŒãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã§ãªã„å ´åˆã€ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹
    if (type !== DocumentApp.ElementType.LIST_ITEM && inList) {
      html += '</ul>\n';
      inList = false;
    }

    if (type === DocumentApp.ElementType.PARAGRAPH) {
      var paragraph = element.asParagraph();
      
      // ç”»åƒã‚’å«ã‚€æ®µè½ã®å‡¦ç†
      if (paragraph.findElement(DocumentApp.ElementType.INLINE_IMAGE)) {
        var imgPlaceholder = images[imageIndex] ? images[imageIndex].placeholder : '';
        var captionText = processParagraph(paragraph, true); // ç”»åƒã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
        html += '<div class="image-container">\n';
        html += '  <img src="' + imgPlaceholder + '" alt="' + captionText.replace(/"/g, '&quot;') + '" class="blog-image" />\n';
        if (captionText) {
          html += '  <p class="image-caption">' + captionText + '</p>\n';
        }
        html += '</div>\n';
        imageIndex++;
        continue; // ç”»åƒå‡¦ç†å¾Œã¯æ¬¡ã®è¦ç´ ã¸
      }

      // ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã®æ®µè½ã®å‡¦ç†
      var heading = paragraph.getHeading();
      var paragraphText = paragraph.getText().trim();

      if (paragraphText === '') continue; // ç©ºã®æ®µè½ã¯ã‚¹ã‚­ãƒƒãƒ—

      if (heading !== DocumentApp.ParagraphHeading.NORMAL) {
        // è¦‹å‡ºã—ã®å‡¦ç†
        var level;
        switch (heading) {
          case DocumentApp.ParagraphHeading.HEADING1: level = 2; break; // H1ã¯ã‚¿ã‚¤ãƒˆãƒ«ãªã®ã§H2ã‹ã‚‰
          case DocumentApp.ParagraphHeading.HEADING2: level = 3; break;
          case DocumentApp.ParagraphHeading.HEADING3: level = 4; break;
          case DocumentApp.ParagraphHeading.HEADING4: level = 5; break;
          case DocumentApp.ParagraphHeading.HEADING5: level = 6; break;
          case DocumentApp.ParagraphHeading.HEADING6: level = 6; break;
          default: level = 3; // ä¸æ˜ãªå ´åˆã¯H3
        }
        var headingId = 'heading-' + toc.length;
        var formattedText = processParagraph(paragraph);
        html += '<h' + level + ' id="' + headingId + '">' + formattedText + '</h' + level + '>\n';
        toc.push({ text: paragraph.getText(), level: level, id: headingId });
      } else {
        // é€šå¸¸ã®æ®µè½
        html += '<p>' + processParagraph(paragraph) + '</p>\n';
      }

    } else if (type === DocumentApp.ElementType.LIST_ITEM) {
      // ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®å‡¦ç†
      if (!inList) {
        html += '<ul>\n';
        inList = true;
      }
      var listItem = element.asListItem();
      html += '  <li>' + processParagraph(listItem) + '</li>\n';
    }
  }

  // ãƒ«ãƒ¼ãƒ—ã®æœ€å¾Œã«ãƒªã‚¹ãƒˆãŒé–‹ã„ãŸã¾ã¾ãªã‚‰é–‰ã˜ã‚‹
  if (inList) {
    html += '</ul>\n';
  }

  return { content: html, toc: toc };
}

/**
 * æ®µè½ã¾ãŸã¯ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ å†…ã®ãƒ†ã‚­ã‚¹ãƒˆæ›¸å¼ã‚’å‡¦ç†ã—ã¦HTMLã‚’ç”Ÿæˆ
 * @param {ContainerElement} element - Paragraphã¾ãŸã¯ListItemã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @param {boolean} ignoreImages - ç”»åƒã‚’ç„¡è¦–ã™ã‚‹ã‹ã©ã†ã‹
 * @returns {string} - æ›¸å¼è¨­å®šã•ã‚ŒãŸHTMLæ–‡å­—åˆ—
 */
function processParagraph(element, ignoreImages) {
  if (ignoreImages === undefined) {
    ignoreImages = false;
  }
  var html = '';
  if (!element.getNumChildren) return '';

  for (var i = 0; i < element.getNumChildren(); i++) {
    var child = element.getChild(i);
    var type = child.getType();

    if (type === DocumentApp.ElementType.TEXT) {
      var textElement = child.asText();
      var text = textElement.getText();
      if (text.trim() === '') continue;

      var attributes = textElement.getAttributes();
      var linkUrl = attributes[DocumentApp.Attribute.LINK_URL];
      var isBold = attributes[DocumentApp.Attribute.BOLD];
      var isItalic = attributes[DocumentApp.Attribute.ITALIC];
      var isUnderline = attributes[DocumentApp.Attribute.UNDERLINE];

      var partialHtml = text.replace(/\n/g, '<br>');

      if (isUnderline) partialHtml = '<u>' + partialHtml + '</u>';
      if (isItalic) partialHtml = '<em>' + partialHtml + '</em>';
      if (isBold) partialHtml = '<strong>' + partialHtml + '</strong>';
      if (linkUrl) {
        partialHtml = '<a href="' + linkUrl + '" target="_blank" rel="noopener noreferrer">' + partialHtml + '</a>';
      }
      
      html += partialHtml;
    } else if (type === DocumentApp.ElementType.INLINE_IMAGE && !ignoreImages) {
      // ã“ã®ã‚±ãƒ¼ã‚¹ã¯åŸºæœ¬çš„ã«è¦ªã® `convertDocToHTMLWithImages` ã§å‡¦ç†ã•ã‚Œã‚‹ãŒã€
      // å¿µã®ãŸã‚ç©ºã®æ–‡å­—åˆ—ã‚’è¿”ã—ã¦ãŠã
      html += '';
    }
  }
  return html;
}

/**
 * ç”»åƒã‚’GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
 */
function uploadImageToGitHub(imageData) {
  try {
    var base64Content = Utilities.base64Encode(imageData.blob.getBytes());
    var imagePath = 'images/blog/' + imageData.filename;
    
    // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
    var sha = null;
    try {
      var getUrl = 'https://api.github.com/repos/' + GITHUB_CONFIG.owner + '/' + GITHUB_CONFIG.repo + '/contents/' + imagePath;
      var getResponse = UrlFetchApp.fetch(getUrl, {
        headers: {
          'Authorization': 'token ' + GITHUB_CONFIG.token,
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      
      if (getResponse.getResponseCode() === 200) {
        var fileData = JSON.parse(getResponse.getContentText());
        sha = fileData.sha;
      }
    } catch (e) {
      // æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«
    }
    
    var payload = {
      message: 'Add blog image: ' + imageData.filename,
      content: base64Content,
      branch: GITHUB_CONFIG.branch
    };
    
    if (sha) {
      payload.sha = sha;
    }
    
    var url = 'https://api.github.com/repos/' + GITHUB_CONFIG.owner + '/' + GITHUB_CONFIG.repo + '/contents/' + imagePath;
    
    var response = UrlFetchApp.fetch(url, {
      method: 'PUT',
      headers: {
        'Authorization': 'token ' + GITHUB_CONFIG.token,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      payload: JSON.stringify(payload)
    });
    
    if (response.getResponseCode() === 201 || response.getResponseCode() === 200) {
      console.log('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: ' + imageData.filename);
      return {
        success: true,
        url: 'https://white-hotel.archi-prisma.co.jp/' + imagePath
      };
    } else {
      throw new Error('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + response.getResponseCode() + ' - ' + response.getContentText());
    }
    
  } catch (error) {
    console.error('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
    return {
      success: false,
      error: error.toString()
    };
  }
}

/**
 * GitHubã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ/æ›´æ–°
 */
function createOrUpdateFile(path, content, message) {
  var base64Content = Utilities.base64Encode(content, Utilities.Charset.UTF_8);
  
  var sha = null;
  try {
    var getUrl = 'https://api.github.com/repos/' + GITHUB_CONFIG.owner + '/' + GITHUB_CONFIG.repo + '/contents/' + path;
    var getResponse = UrlFetchApp.fetch(getUrl, {
      headers: {
        'Authorization': 'token ' + GITHUB_CONFIG.token,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (getResponse.getResponseCode() === 200) {
      var fileData = JSON.parse(getResponse.getContentText());
      sha = fileData.sha;
    }
  } catch (e) {
    console.log('æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ');
  }
  
  var payload = {
    message: message,
    content: base64Content,
    branch: GITHUB_CONFIG.branch
  };
  
  if (sha) {
    payload.sha = sha;
  }
  
  var url = 'https://api.github.com/repos/' + GITHUB_CONFIG.owner + '/' + GITHUB_CONFIG.repo + '/contents/' + path;
  
  var response = UrlFetchApp.fetch(url, {
    method: 'PUT',
    headers: {
      'Authorization': 'token ' + GITHUB_CONFIG.token,
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json'
    },
    payload: JSON.stringify(payload)
  });
  
  if (response.getResponseCode() !== 200 && response.getResponseCode() !== 201) {
    throw new Error('GitHub API Error: ' + response.getResponseCode());
  }
  
  console.log('ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°æˆåŠŸ: ' + path);
}

/**
 * GitHubã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
 */
function getFileFromGitHub(path) {
  var url = 'https://api.github.com/repos/' + GITHUB_CONFIG.owner + '/' + GITHUB_CONFIG.repo + '/contents/' + path;
  
  var response = UrlFetchApp.fetch(url, {
    headers: {
      'Authorization': 'token ' + GITHUB_CONFIG.token,
      'Accept': 'application/vnd.github.v3+json'
    }
  });
  
  if (response.getResponseCode() !== 200) {
    throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼: ' + path);
  }
  
  var fileData = JSON.parse(response.getContentText());
  var content = Utilities.base64Decode(fileData.content, Utilities.Charset.UTF_8);
  return { content: content, sha: fileData.sha };
}

/**
 * ãƒ–ãƒ­ã‚°ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°
 */
function updateBlogIndexOnGitHub(title, fileName) {
  try {
    var today = new Date();
    var dateStr = Utilities.formatDate(today, 'JST', 'yyyyå¹´MMæœˆddæ—¥');
    
    var blogFile = getFileFromGitHub('blog.html');
    var blogContent;
    if (typeof blogFile.content === 'string') {
      blogContent = blogFile.content;
    } else {
      blogContent = Utilities.newBlob(blogFile.content).getDataAsString('UTF-8');
    }
    
    console.log('blog.htmlå–å¾—æˆåŠŸ');
    
    var excerpt = generateExcerpt(title);
    
    var newBlogItem = '                <li class="blog-post-item">' + '\n' + 
                      '                    <h2><a href="blog/' + fileName + '">' + title + '</a></h2>' + '\n' + 
                      '                    <p class="blog-post-meta">' + dateStr + '</p>' + '\n' + 
                      '                    <p class="blog-post-excerpt">' + excerpt + '</p>' + '\n' + 
                      '                </li>';
    
    var insertPoint = blogContent.indexOf('<li class="blog-post-item">');
    
    if (insertPoint !== -1) {
      console.log('æ—¢å­˜è¨˜äº‹ã®å‰ã«æŒ¿å…¥');
      blogContent = blogContent.substring(0, insertPoint) + newBlogItem + '\n' + blogContent.substring(insertPoint);
    } else {
      var listStartPattern = '<ul class="blog-post-list">';
      var listStart = blogContent.indexOf(listStartPattern);
      
      if (listStart !== -1) {
        var insertAfterTag = listStart + listStartPattern.length;
        console.log('ç©ºã®ãƒªã‚¹ãƒˆã«æŒ¿å…¥');
        blogContent = blogContent.substring(0, insertAfterTag) + '\n' + newBlogItem + blogContent.substring(insertAfterTag);
      } else {
        console.error('ãƒªã‚¹ãƒˆè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
    }
    
    createOrUpdateFile('blog.html', blogContent, 'Update blog index: add ' + title);
    console.log('ãƒ–ãƒ­ã‚°ä¸€è¦§æ›´æ–°å®Œäº†');
    
  } catch (error) {
    console.error('ãƒ–ãƒ­ã‚°ä¸€è¦§æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
  }
}

/**
 * ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰é©åˆ‡ãªæŠœç²‹ã‚’ç”Ÿæˆ
 */
function generateExcerpt(title) {
  if (title.indexOf('éŒå€‰') !== -1) {
    return 'ãƒ›ãƒ¯ã‚¤ãƒˆãƒ›ãƒ†ãƒ«éŒå€‰å‘¨è¾ºã®é­…åŠ›çš„ãªã‚¹ãƒãƒƒãƒˆã‚„ä½“é¨“ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚';
  } else if (title.indexOf('ã‚°ãƒ«ãƒ¡') !== -1 || title.indexOf('ã‚«ãƒ•ã‚§') !== -1) {
    return 'éŒå€‰ã®ç¾å‘³ã—ã„ãŠåº—ã‚„ã‚«ãƒ•ã‚§æƒ…å ±ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚';
  } else if (title.indexOf('ãƒ›ãƒ†ãƒ«') !== -1) {
    return 'ãƒ›ãƒ¯ã‚¤ãƒˆãƒ›ãƒ†ãƒ«éŒå€‰ã§ã®æ»åœ¨ã‚’ã‚ˆã‚Šç‰¹åˆ¥ãªã‚‚ã®ã«ã™ã‚‹æƒ…å ±ã§ã™ã€‚';
  } else if (title.indexOf('æ±Ÿãƒé›»') !== -1) {
    return 'æ±Ÿãƒé›»æ²¿ç·šã®é­…åŠ›ã‚„ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±ã‚’ã”æ¡ˆå†…ã—ã¾ã™ã€‚';
  } else if (title.indexOf('å»ºç¯‰') !== -1) {
    return 'ãƒ›ãƒ†ãƒ«ã®å»ºç¯‰ã‚„ãƒ‡ã‚¶ã‚¤ãƒ³ã«ã¾ã¤ã‚ã‚‹ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ã”ç´¹ä»‹ã€‚';
  } else if (title.indexOf('å­£ç¯€') !== -1) {
    return 'å­£ç¯€ã”ã¨ã®éŒå€‰ã®æ¥½ã—ã¿æ–¹ã‚’ãŠä¼ãˆã—ã¾ã™ã€‚';
  } else {
    return title + 'ã«ã¤ã„ã¦ã”ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚';
  }
}

/**
 * ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
 */
function createSlug(title) {
  var today = new Date();
  var datePrefix = Utilities.formatDate(today, 'JST', 'yyyy-MM-dd');
  var timeStamp = Date.now().toString().slice(-6);
  return datePrefix + '-blog-' + timeStamp;
}

/**
 * å¼·åŒ–ã•ã‚ŒãŸHTMLãƒšãƒ¼ã‚¸ã‚’ç”Ÿæˆï¼ˆç›®æ¬¡ä»˜ãï¼‰
 */
function createEnhancedBlogHTML(content, title, toc) {
  var today = new Date();
  var dateStr = Utilities.formatDate(today, 'JST', 'yyyyå¹´MMæœˆddæ—¥');
  var isoDate = Utilities.formatDate(today, 'JST', "yyyy-MM-dd'T'HH:mm:ssXXX");
  var slug = createSlug(title);
  var excerpt = generateExcerpt(title);
  
  // ç›®æ¬¡HTMLç”Ÿæˆ
  var tocHtml = '';
  if (toc && toc.length > 0) {
    tocHtml = '<div class="table-of-contents">\n';
    tocHtml += '<h3 class="toc-title">ğŸ“‹ ã“ã®è¨˜äº‹ã®ç›®æ¬¡</h3>\n';
    tocHtml += '<ul class="toc-list">\n';
    for (var i = 0; i < toc.length; i++) {
      var tocItem = toc[i];
      tocHtml += '<li class="toc-item toc-level-' + tocItem.level + '">';
      tocHtml += '<a href="#' + tocItem.id + '" class="toc-link">' + tocItem.text + '</a>';
      tocHtml += '</li>\n';
    }
    tocHtml += '</ul>\n';
    tocHtml += '</div>\n';
  }
  
  var html = '<!DOCTYPE html>\n';
  html += '<html lang="ja">\n';
  html += '<head>\n';
  html += '    <meta charset="UTF-8">\n';
  html += '    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n';
  html += '    <title>' + title + ' | ãƒ›ãƒ¯ã‚¤ãƒˆãƒ›ãƒ†ãƒ«éŒå€‰</title>\n';
  html += '    <meta name="description" content="' + excerpt + '">
';
  html += '    <meta name="keywords" content="ãƒ›ãƒ¯ã‚¤ãƒˆãƒ›ãƒ†ãƒ«éŒå€‰,éŒå€‰è¦³å…‰,æ±Ÿãƒé›»,ãƒ–ãƒ­ã‚°">
';
  html += '    
';
  html += '    <!-- Open Graph -->
';
  html += '    <meta property="og:type" content="article">
';
  html += '    <meta property="og:title" content="' + title + ' | ãƒ›ãƒ¯ã‚¤ãƒˆãƒ›ãƒ†ãƒ«éŒå€‰">
';
  html += '    <meta property="og:description" content="' + excerpt + '">
';
  html += '    <meta property="og:url" content="https://white-hotel.archi-prisma.co.jp/blog/' + slug + '.html">
';
  html += '    <meta property="og:image" content="https://white-hotel.archi-prisma.co.jp/images/blog-og-image.jpg">
';
  html += '    
';
  html += '    <!-- Twitter -->
';
  html += '    <meta name="twitter:card" content="summary_large_image">
';
  html += '    <meta name="twitter:title" content="' + title + ' | ãƒ›ãƒ¯ã‚¤ãƒˆãƒ›ãƒ†ãƒ«éŒå€‰">
';
  html += '    <meta name="twitter:description" content="' + excerpt + '">
';
  html += '    <meta name="twitter:image" content="https://white-hotel.archi-prisma.co.jp/images/blog-og-image.jpg">
';
  html += '    
';
  html += '    <link rel="canonical" href="https://white-hotel.archi-prisma.co.jp/blog/' + slug + '.html">
';
  html += '    <link rel="icon" type="image/png" href="https://white-hotel.archi-prisma.co.jp/images/logo_white hotel kamakura.png">
';
  html += '    <link rel="stylesheet" href="https://white-hotel.archi-prisma.co.jp/style.css">
';
  html += '    
';
  html += '    <!-- Structured Data -->
';
  html += '    <script type="application/ld+json">
';
  html += '    {
';
  html += '      "@context": "https://schema.org",
';
  html += '      "@type": "BlogPosting",
';
  html += '      "headline": "' + title + '",
';
  html += '      "description": "' + excerpt + '",
';
  html += '      "datePublished": "' + isoDate + '",
';
  html += '      "dateModified": "' + isoDate + '",
';
  html += '      "author": {
';
  html += '        "@type": "Organization",
';
  html += '        "name": "ãƒ›ãƒ¯ã‚¤ãƒˆãƒ›ãƒ†ãƒ«éŒå€‰"
';
  html += '      },
';
  html += '      "publisher": {
';
  html += '        "@type": "Organization",
';
  html += '        "name": "ãƒ›ãƒ¯ã‚¤ãƒˆãƒ›ãƒ†ãƒ«éŒå€‰",
';
  html += '        "logo": {
';
  html += '          "@type": "ImageObject",
';
  html += '          "url": "https://white-hotel.archi-prisma.co.jp/images/logo_white hotel kamakura.png"
';
  html += '        }
';
  html += '      },
';
  html += '      "mainEntityOfPage": {
';
  html += '        "@type": "WebPage",
';
  html += '        "@id": "https://white-hotel.archi-prisma.co.jp/blog/' + slug + '.html"
';
  html += '      }
';
  html += '    }
';
  html += '    </script>
';
  html += '    
';
  html += '    <style>
';
  html += '        body {
';
  html += '            background-color: var(--bg-offwhite);
';
  html += '            padding-top: 80px;
';
  html += '            font-family: "Noto Sans JP", sans-serif;
';
  html += '            line-height: 1.8;
';
  html += '            color: var(--text-primary);
';
  html += '        }
';
  html += '        .article-container {
';
  html += '            max-width: 900px;
';
  html += '            margin: 2rem auto;
';
  html += '            padding: 0 1rem;
';
  html += '        }
';
  html += '        .article-card {
';
  html += '            background: var(--white);
';
  html += '            border-radius: 20px;
';
  html += '            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
';
  html += '            overflow: hidden;
';
  html += '        }
';
  html += '        .article-header {
';
  html += '            background: linear-gradient(135deg, var(--primary-color) 0%, #2c5282 100%);
';
  html += '            color: white;
';
  html += '            padding: 3rem 2rem;
';
  html += '            text-align: center;
';
  html += '        }
';
  html += '        .article-title {
';
  html += '            font-size: 2.8rem;
';
  html += '            margin-bottom: 1rem;
';
  html += '            font-weight: 700;
';
  html += '            line-height: 1.3;
';
  html += '        }
';
  html += '        .article-meta {
';
  html += '            font-size: 1.1rem;
';
  html += '            opacity: 0.9;
';
  html += '        }
';
  html += '        .article-content {
';
  html += '            padding: 3rem 2rem;
';
  html += '        }
';
  html += '        
';
  html += '        /* ç›®æ¬¡ã‚¹ã‚¿ã‚¤ãƒ« */
';
  html += '        .table-of-contents {
';
  html += '            background: var(--bg-offwhite);
';
  html += '            border-radius: 15px;
';
  html += '            padding: 2rem;
';
  html += '            margin: 2rem 0;
';
  html += '            border-left: 4px solid var(--primary-color);
';
  html += '        }
';
  html += '        .toc-title {
';
  html += '            font-size: 1.4rem;
';
  html += '            color: var(--primary-color);
';
  html += '            margin-bottom: 1rem;
';
  html += '            font-weight: 600;
';
  html += '        }
';
  html += '        .toc-list {
';
  html += '            list-style: none;
';
  html += '            padding: 0;
';
  html += '            margin: 0;
';
  html += '        }
';
  html += '        .toc-item {
';
  html += '            margin-bottom: 0.8rem;
';
  html += '        }
';
  html += '        .toc-level-2 { margin-left: 0; }
';
  html += '        .toc-level-3 { margin-left: 1.5rem; }
';
  html += '        .toc-level-4 { margin-left: 3rem; }
';
  html += '        .toc-link {
';
  html += '            color: var(--text-secondary);
';
  html += '            text-decoration: none;
';
  html += '            font-size: 1rem;
';
  html += '            transition: color 0.3s ease;
';
  html += '        }
';
  html += '        .toc-link:hover {
';
  html += '            color: var(--primary-color);
';
  html += '        }
';
  html += '        
';
  html += '        /* æœ¬æ–‡ã‚¹ã‚¿ã‚¤ãƒ« */
';
  html += '        .article-content h2 {
';
  html += '            color: var(--primary-color);
';
  html += '            margin: 3rem 0 1.5rem;
';
  html += '            font-size: 2rem;
';
  html += '            border-left: 4px solid var(--primary-color);
';
  html += '            padding-left: 1rem;
';
  html += '            font-weight: 600;
';
  html += '        }
';
  html += '        .article-content h3 {
';
  html += '            color: var(--text-primary);
';
  html += '            margin: 2.5rem 0 1rem;
';
  html += '            font-size: 1.6rem;
';
  html += '            font-weight: 600;
';
  html += '            border-bottom: 2px solid var(--border-light);
';
  html += '            padding-bottom: 0.5rem;
';
  html += '        }
';
  html += '        .article-content h4 {
';
  html += '            color: var(--text-primary);
';
  html += '            margin: 2rem 0 0.8rem;
';
  html += '            font-size: 1.3rem;
';
  html += '            font-weight: 600;
';
  html += '        }
';
  html += '        .article-content p {
';
  html += '            margin-bottom: 1.8rem;
';
  html += '            font-size: 1.15rem;
';
  html += '            line-height: 1.9;
';
  html += '        }
';
  html += '        
';
  html += '        /* ç”»åƒã‚¹ã‚¿ã‚¤ãƒ« */
';
  html += '        .blog-image {
';
  html += '            max-width: 100%;
';
  html += '            height: auto;
';
  html += '            border-radius: 12px;
';
  html += '            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
';
  html += '            margin: 1rem 0;
';
  html += '            transition: transform 0.3s ease;
';
  html += '        }
';
  html += '        .blog-image:hover {
';
  html += '            transform: scale(1.02);
';
  html += '        }
';
  html += '        .image-container {
';
  html += '            text-align: center;
';
  html += '            margin: 2.5rem 0;
';
  html += '            background: var(--bg-offwhite);
';
  html += '            padding: 2rem;
';
  html += '            border-radius: 15px;
';
  html += '        }
';
  html += '        .image-caption {
';
  html += '            margin-top: 1rem;
';
  html += '            font-size: 0.9rem;
';
  html += '            color: var(--text-secondary);
';
  html += '            font-style: italic;
';
  html += '        }
';
  html += '        
';
  html += '        .back-link {
';
  html += '            display: block;
';
  html += '            text-align: center;
';
  html += '            margin: 3rem auto;
';
  html += '            padding: 1.2rem 2.5rem;
';
  html += '            background: var(--white);
';
  html += '            color: var(--primary-color);
';
  html += '            text-decoration: none;
';
  html += '            border-radius: 50px;
';
  html += '            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
';
  html += '            max-width: 350px;
';
  html += '            font-size: 1.1rem;
';
  html += '            font-weight: 500;
';
  html += '            transition: all 0.3s ease;
';
  html += '        }
';
  html += '        .back-link:hover {
';
  html += '            transform: translateY(-2px);
';
  html += '            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
';
  html += '        }
';
  html += '        
';
  html += '        @media (max-width: 768px) {
';
  html += '            .article-title { font-size: 2rem; }
';
  html += '            .article-header { padding: 2rem 1rem; }
';
  html += '            .article-content { padding: 2rem 1rem; }
';
  html += '            .article-content h2 { font-size: 1.6rem; }
';
  html += '            .article-content h3 { font-size: 1.4rem; }
';
  html += '            .article-content p { font-size: 1.1rem; }
';
  html += '            .table-of-contents { padding: 1.5rem; }
';
  html += '            .image-container { padding: 1rem; }
';
  html += '        }
';
  html += '    </style>
';
  html += '</head>
';
  html += '<body>
';
  html += '    <header id="header">
';
  html += '        <div class="container">
';
  html += '            <div class="header-content">
';
  html += '                <a href="https://white-hotel.archi-prisma.co.jp/index.html" class="logo">White Hotel</a>
';
  html += '                <nav class="nav-menu">
';
  html += '                    <a href="https://white-hotel.archi-prisma.co.jp/index.html#home" class="nav-link">ãƒ›ãƒ¼ãƒ </a>
';
  html += '                    <a href="https://white-hotel.archi-prisma.co.jp/blog.html" class="nav-link">ãƒ–ãƒ­ã‚°</a>
';
  html += '                </nav>
';
  html += '            </div>
';
  html += '        </div>
';
  html += '    </header>
';
  html += '    <main>
';
  html += '        <article class="article-container">
';
  html += '            <div class="article-card">
';
  html += '                <header class="article-header">
';
  html += '                    <h1 class="article-title">' + title + '</h1>
';
  html += '                    <div class="article-meta">' + dateStr + ' | ãƒ›ãƒ¯ã‚¤ãƒˆãƒ›ãƒ†ãƒ«éŒå€‰</div>
';
  html += '                </header>
';
  html += '                <div class="article-content">
';
  html += '                    ' + tocHtml + '
';
  html += '                    ' + content + '
';
  html += '                </div>
';
  html += '            </div>
';
  html += '        </article>
';
  html += '        <a href="https://white-hotel.archi-prisma.co.jp/blog.html" class="back-link">â† ãƒ–ãƒ­ã‚°ä¸€è¦§ã«æˆ»ã‚‹</a>
';
  html += '    </main>
';
  html += '    
';
  html += '    <script>
';
  html += '        // ç›®æ¬¡ã®ã‚¹ãƒ ãƒ¼ã‚¹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
';
  html += '        document.querySelectorAll(".toc-link").forEach(link => {
';
  html += '            link.addEventListener("click", function(e) {
';
  html += '                e.preventDefault();
';
  html += '                const targetId = this.getAttribute("href").substring(1);
';
  html += '                const targetElement = document.getElementById(targetId);
';
  html += '                if (targetElement) {
';
  html += '                    targetElement.scrollIntoView({ behavior: "smooth", block: "start" });
';
  html += '                }
';
  html += '            });
';
  html += '        });
';
  html += '        
';
  html += '        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
';
  html += '        window.addEventListener("load", function() {
';
  html += '            document.body.style.opacity = "0";
';
  html += '            document.body.style.transition = "opacity 0.3s ease";
';
  html += '            setTimeout(() => {
';
  html += '                document.body.style.opacity = "1";
';
  html += '            }, 100);
';
  html += '        });
';
  html += '    </script>
';
  html += '</body>
';
  html += '</html>';
  
  return html;
}

/**
 * Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å®Ÿè¡Œã™ã‚‹é–¢æ•°
 */
function publishCurrentDocumentToGitHub() {
  try {
    var doc = DocumentApp.getActiveDocument();
    if (!doc) {
      console.error('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    var result = publishBlogToGitHub(doc.getId());
    
    if (result.success) {
      var successHTML = '<div style="padding: 20px; font-family: Arial, sans-serif;">' +
        '<h2 style="color: #4CAF50;">âœ… å…¬é–‹æˆåŠŸï¼</h2>' +
        '<p>' + result.message + '</p>' +
        '<p><strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ' + result.fileName + '</p>' +
        '<p><strong>URL:</strong> <a href="' + result.url + '" target="_blank">' + result.url + '</a></p>' +
        '<p><strong>ç”»åƒæ•°:</strong> ' + result.imagesCount + 'æš</p>' +
        '<button onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>' +
        '</div>';
      
      var htmlOutput = HtmlService.createHtmlOutput(successHTML).setWidth(500).setHeight(350);
      DocumentApp.getUi().showModalDialog(htmlOutput, 'ãƒ–ãƒ­ã‚°å…¬é–‹å®Œäº†ï¼ˆç”»åƒå¯¾å¿œä¿®æ­£ç‰ˆï¼‰');
    } else {
      var errorHTML = '<div style="padding: 20px; font-family: Arial, sans-serif;">' +
        '<h2 style="color: #f44336;">âŒ ã‚¨ãƒ©ãƒ¼</h2>' +
        '<p>' + result.message + '</p>' +
        '<button onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>' +
        '</div>';
      
      var htmlOutput = HtmlService.createHtmlOutput(errorHTML).setWidth(400).setHeight(200);
      DocumentApp.getUi().showModalDialog(htmlOutput, 'ã‚¨ãƒ©ãƒ¼');
    }
  } catch (error) {
    console.error('å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
  }
}

/**
 * Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
 */
function onOpen() {
  DocumentApp.getUi()
    .createMenu('ãƒ›ãƒ¯ã‚¤ãƒˆãƒ›ãƒ†ãƒ« ãƒ–ãƒ­ã‚°')
    .addItem('GitHubã«å…¬é–‹ï¼ˆç”»åƒå¯¾å¿œä¿®æ­£ç‰ˆï¼‰', 'publishCurrentDocumentToGitHub')
    .addToUi();
}

/**
 * ç”»åƒæ¤œå‡ºãƒ†ã‚¹ãƒˆé–¢æ•°
 */
function testImageDetection() {
  try {
    var doc = DocumentApp.getActiveDocument();
    if (!doc) {
      console.error('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    console.log('ç”»åƒæ¤œå‡ºãƒ†ã‚¹ãƒˆé–‹å§‹...');
    var images = extractAllImages(doc);
    console.log('æ¤œå‡ºçµæœ: ' + images.length + 'æšã®ç”»åƒ');
    
    for (var i = 0; i < images.length; i++) {
      console.log('ç”»åƒ ' + (i + 1) + ': ' + images[i].filename);
    }
    
    var testHTML = '<div style="padding: 20px; font-family: Arial, sans-serif;">' +
      '<h2>ç”»åƒæ¤œå‡ºãƒ†ã‚¹ãƒˆçµæœ</h2>' +
      '<p>æ¤œå‡ºã•ã‚ŒãŸç”»åƒæ•°: <strong>' + images.length + '</strong></p>' +
      '<button onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>' +
      '</div>';
    
    var htmlOutput = HtmlService.createHtmlOutput(testHTML).setWidth(400).setHeight(200);
    DocumentApp.getUi().showModalDialog(htmlOutput, 'ç”»åƒæ¤œå‡ºãƒ†ã‚¹ãƒˆ');
    
  } catch (error) {
    console.error('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
  }
}

/**
 * æ¥ç¶šãƒ†ã‚¹ãƒˆ
 */
function testConnection() {
  try {
    var url = 'https://api.github.com/repos/' + GITHUB_CONFIG.owner + '/' + GITHUB_CONFIG.repo;
    var response = UrlFetchApp.fetch(url, {
      headers: {
        'Authorization': 'token ' + GITHUB_CONFIG.token,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (response.getResponseCode() === 200) {
      console.log('GitHubæ¥ç¶šæˆåŠŸï¼');
      return true;
    } else {
      console.error('GitHubæ¥ç¶šå¤±æ•—:', response.getResponseCode());
      return false;
    }
  } catch (error) {
    console.error('æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
    return false;
  }
}
